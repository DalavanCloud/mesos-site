<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Apache Mesos: Mesos Image Provisioner</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Apache Mesos
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Mesos Image Provisioner </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Motivation</h2>
<p>There are multiple container specifications, notably <a class="el" href="classDocker.html">Docker</a>, Appc (rkt), and recently OCP (oci). Most of the container specifications, to varying degrees, conflate image format specification with other components of a container, including execution and resource isolation, both in specification and implementation.</p>
<p>The goal of Mesos Image Provisioner is to extend the MesosContainerizer to support provisioning container filesystems from different image formats while composing with the existing Isolators for resource isolation.</p>
<p>Mesos image provisioner allows Mesos containers to be created and managed through Mesos containerizer to have a root filesystem provisioned with image bundles with common image specification formats such as AppContainer and <a class="el" href="classDocker.html">Docker</a>.</p>
<h2>Glossary</h2>
<p>Layer: A layer is typically a filesystem changeset.</p>
<p>Image: An image in this documentation refers to a container filesystem image. A filesystem image typically contains one or more layers.</p>
<h2>Framework API</h2>
<p>We introduced a new protobuf message <code>Image</code> that describes a container filesystem image.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;message Image {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  enum Type {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    APPC = 1;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    DOCKER = 2;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    // More Image types.</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  }</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  message Appc {</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    // Appc configurations.</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;  }</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;  message Docker {</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    // Docker configurations</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;  }</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;  required Type type = 1;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;  // Only one of the following image messages should be set to match</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;  // the type.</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;  optional Appc appc = 2;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;  optional Docker docker = 3;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;}</div></div><!-- fragment --><p>This <code>Image</code> message type contains the type of image specification and the corresponding configurations for that type.</p>
<p>The image type is currently supported to be specified in both ContainerInfo and Volume.</p>
<p>When ContainerInfo image is configured, the Mesos image provisioner provides a root filesystem to the task. On the other hand, when volume(s) are configured with an image, that volume will be mounted with the image filesystem configured.</p>
<p>Image can both be configured in a Volume and in ContainerInfo at the same time.</p>
<h2>Setup and Agent Flags</h2>
<p>To run the agent to enable Mesos containerizer, you must launch the agent with mesos as a containerizer option, which is the default containerizer for the mesos agent. It also has to enable filesystem/linux as part of the enabled isolators. The supported image providers can also be configured through agent flags, as well as the supported image provider backend.</p>
<p>Mesos agent also needs to be running under linux with root permissions.</p>
<ul>
<li>Example: <code>mesos-slave --containerizers=mesos --image_providers=appc,docker --image_provisioner_backend=copy --isolation=filesystem/linux</code></li>
</ul>
<p>Each Image provider can have additional configurations that can be set.</p>
<h2>Mesos Image Provisioner</h2>
<p>Mesos provisioner forwards the container image request to the corresponding Image Provider to provision the image changesets (layers), and then ask the configured Backend to provision a root filesystem from the layers.</p>
<h2>Image providers</h2>
<p>An image provider is a provider that understands how to discover, download and unpack a particular image format. Mesos agent supports multiple image providers and the <code>image_providers</code> agent flag allows operators to choose which ones to support.</p>
<h3>Appc</h3>
<p><a href="https://github.com/appc/spec/blob/master/spec/aci.md">https://github.com/appc/spec/blob/master/spec/aci.md</a></p>
<p>TODO(tnachen): Add Appc information.</p>
<h3><a class="el" href="classDocker.html">Docker</a></h3>
<p><a href="https://github.com/docker/docker/blob/master/image/spec/v1.md">https://github.com/docker/docker/blob/master/image/spec/v1.md</a></p>
<p><a class="el" href="classDocker.html">Docker</a> image provider supports two different methods of finding and pulling images: local and registry. The <code>docker_registry</code> agent flag allows the slave to choose between these methods based on the URL scheme.</p>
<p>By specifying a URL in <code>docker_registry</code> agent flag pointing to a local directory (<a href="file:///tmp/mesos/images/docker">file:///tmp/mesos/images/docker</a>), the provisioner will use the Local puller to find docker images based on image name and tag in the host filesystem.</p>
<p>If the URL configured in <code>docker_registry</code> isn't pointing to a local directory, it will be assumed to be a registry referring to a <a class="el" href="classDocker.html">Docker</a> registry. The Registry puller will find and download images by contacting <a class="el" href="classDocker.html">Docker</a> registry with the configured URL when no custom registry is specified.</p>
<p>Note that to run the Registry puller Mesos agent must be running with SSL enabled.</p>
<h2>Image provisioner backend</h2>
<p>A provisioner backend takes the layers that the image provider provided and build a root filesystem for a container or volume.</p>
<h3>Copy</h3>
<p>The Copy backend simply copies all the layers into a target root directory to create a root filesystem.</p>
<h3>Bind</h3>
<p>This is a specialized backend that may be useful for deployments using large (multi-GB) single-layer images <em>and</em> where more recent kernel features such as overlayfs are not available (overlayfs-based backend tracked by MESOS-2971). For small images (10's to 100's of MB) the copy backend may be sufficient. Bind backend is faster than Copy as it requires nearly zero IO.</p>
<p>The Bind backend currently has these two limitations: 1) BindBackend supports only a single layer. Multi-layer images will fail to provision and the container will fail to launch! 2) The filesystem is read-only because all containers using this image share the source. Select writable areas can be achieved by mounting read-write volumes to places like /tmp, /var/tmp, /home, etc. using the ContainerInfo. These can be relative to the executor work directory. Since the filesystem is read-only, '&ndash;sandbox_directory' must already exist within the filesystem because the filesystem isolator is unable to create it!</p>
<h2>Internals</h2>
<p>The design doc is available <a href="https://docs.google.com/document/d/1Fx5TS0LytV7u5MZExQS0-g-gScX2yKCKQg9UPFzhp6U">here</a>.</p>
<h2>Related Docs</h2>
<p>For more information on the Mesos containerizer filesystem, namespace, and isolator features, visit <a class="el" href="mesos-containerizer_8md.html">Mesos Containerizer</a>. For more information on launching <a class="el" href="classDocker.html">Docker</a> containers through the <a class="el" href="classDocker.html">Docker</a> containerizer, visit <a class="el" href="docker-containerizer_8md.html">Docker Containerizer</a>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
