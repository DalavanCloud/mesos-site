<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Apache Mesos: networking-for-mesos-managed-containers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Apache Mesos
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">networking-for-mesos-managed-containers </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
 <h2>layout: documentation </h2>
<h1>Networking for Mesos-managed containers</h1>
<p>While networking plays a key role in data center infrastructure, it is &ndash; for now &ndash; beyond the scope of Mesos to try to address the concerns of networking setup, topology and performance. However, Mesos can ease integrations with existing networking solutions and enable features, like IP per container, task-granular task isolation and service discovery. More often than not, it will be challenging to provide a one-size-fits-all networking solution. The requirements and available solutions will vary across all cloud-only, on-premise, and hybrid deployments.</p>
<p>One of the primary goals for the networking support in Mesos was to have a pluggable mechanism to allow users to enable custom networking solution as needed. As a result, several extensions were added to Mesos components in version 0.25.0 to enable networking support. Further, all the extensions are opt-in to allow older frameworks and applications without networking support to coexist with the newer ones.</p>
<p>The rest of this document describes the overall architecture of all the involved components, configuration steps for enabling IP-per-container, and required framework changes.</p>
<h2>How does it work?</h2>
<div class="image">
<img src="images/networking-architecture.png"  alt="Mesos Networking Architecture"/>
</div>
<p>A key observation is that the networking support is enabled via a Mesos module and thus the Mesos master and agents are completely oblivious of it. It is completely up to the networking module to provide the desired support. Next, the IP requests are provided on a best effort manner. Thus, the framework should be willing to handle ignored (in cases where the module(s) are not present) or declined (the IPs can't be assigned due to various reasons) requests.</p>
<p>To maximize backwards-compatibility with existing frameworks, schedulers must opt-in to network isolation per-container. Schedulers opt in to network isolation using new data structures in the TaskInfo message.</p>
<h3>Terminology</h3>
<ul>
<li>IP Address Management (IPAM) Server<ul>
<li>assigns IPs on demand</li>
<li>recycles IPs once they have been released</li>
<li>(optionally) can tag IPs with a given string/id.</li>
</ul>
</li>
<li>IPAM client<ul>
<li>tightly coupled with a particular IPAM server</li>
<li>acts as a bridge between the "Network Isolator Module" and the IPAM server</li>
<li>communicates with the server to request/release IPs</li>
</ul>
</li>
<li><a class="el" href="classNetwork.html">Network</a> Isolator Module (NIM):<ul>
<li>a Mesos module for the Agent implementing the <code>Isolator</code> interface</li>
<li>looks at TaskInfos to detect the IP requirements for the tasks</li>
<li>communicates with the IPAM client to request/release IPs</li>
<li>communicates with an external network virtualizer/isolator to enable network isolation</li>
</ul>
</li>
<li>Cleanup Module:<ul>
<li>responsible for doing a cleanup (releasing IPs, etc.) during an Agent lost event, dormant otherwise</li>
</ul>
</li>
</ul>
<h3>Framework requests IP address for containers</h3>
<ol type="1">
<li>A Mesos framework uses the TaskInfo message to requests IPs for each container being launched. (The request is ignored if the Mesos cluster doesn't have support for IP-per-container.)</li>
<li>Mesos Master processes TaskInfos and forwards them to the Agent for launching tasks.</li>
</ol>
<h3><a class="el" href="classNetwork.html">Network</a> isolator module gets IP from IPAM server</h3>
<ol type="1">
<li>Mesos Agent inspects the TaskInfo to detect the container requirements (MesosContainerizer in this case) and prepares various Isolators for the to-be-launched container.<ul>
<li>The NIM inspects the TaskInfo to decide whether to enable network isolator or not.</li>
</ul>
</li>
<li>If network isolator is to be enabled, NIM requests IP address(es) via IPAM client and informs the Agent.</li>
</ol>
<h3>Agent launches container with a network namespace</h3>
<ol type="1">
<li>The Agent launches a container within a new network namespace.<ul>
<li>The Agent calls into NIM to perform "isolation"</li>
<li>The NIM then calls into network virtualizer to isolate the container.</li>
</ul>
</li>
</ol>
<h3><a class="el" href="classNetwork.html">Network</a> virtualizer assigns IP address to the container and isolates it.</h3>
<ol type="1">
<li>NIM then "decorates" the TaskStatus with the IP information.<ul>
<li>The IP address(es) from TaskStatus are made available at Master's state endpoint.</li>
<li>The TaskStatus is also forwarded to the framework to inform it of the IP addresses.</li>
<li>When a task is killed or lost, NIM communicates with IPAM client to release corresponding IP address(es).</li>
</ul>
</li>
</ol>
<h3>Cleanup module detects lost Agents and performs cleanup</h3>
<ol type="1">
<li>The cleanup module gets notified if there is an Agent-lost event.</li>
<li>The cleanup module communicates with the IPAM client to release all IP address(es) associated with the lost Agent. The IPAM may have a grace period before the address(es) are recycled.</li>
</ol>
<h2>Configuration</h2>
<p>The network isolator module is not part of standard Mesos distribution. However, there is an example implementation at <a href="https://github.com/mesosphere/net-modules">https://github.com/mesosphere/net-modules</a>.</p>
<p>Once the network isolation module has been built into a shared dynamic library, we can load it into Mesos Agent (see <a class="el" href="modules_8md.html">modules documentation</a> on instructions for building and loading a module).</p>
<h2>Enabling frameworks for IP-per-container capability</h2>
<h3>NetworkInfo</h3>
<p>A new NetworkInfo message has been introduced:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;message NetworkInfo {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  enum Protocol {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    IPv4 = 1;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    IPv6 = 2;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  }</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;  message IPAddress {</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    optional Protocol protocol = 1;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    optional string ip_address = 2;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;  }</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;  repeated IPAddress ip_addresses = 5;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;  optional Protocol protocol = 1 [deprecated = true]; // Since 0.26.0</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;  optional string ip_address = 2 [deprecated = true]; // Since 0.26.0</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;  repeated string groups = 3;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;  optional Labels labels = 4;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;};</div></div><!-- fragment --><p>When requesting an IP address from the IPAM, one needs to set the <code>protocol</code> field to <code>IPv4</code> or <code>IPv6</code>. Setting <code>ip_address</code> to a valid IP address allows the framework to specify a static IP address for the container (if supported by the NIM). This is helpful in situations where a task must be bound to a particular IP address even as it is killed and restarted on a different node.</p>
<h3>Examples of specifying network requirements</h3>
<p>Frameworks wanting to enable IP per container, need to provide <code>NetworkInfo</code> message in TaskInfo. Here are a few examples:</p>
<ol type="1">
<li>A request for one address of unspecified protocol version using the default command executor</li>
</ol>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;TaskInfo {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  ...</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  command: ...,</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  container: ContainerInfo {</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    network_infos: [</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;      NetworkInfo {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        ip_addresses: [</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;          IPAddress {</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;            protocol: None;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;            ip_address: None;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;          }</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        ]</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;        groups: [];</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;        labels: None;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;      }</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    ]</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;  }</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;}</div></div><!-- fragment --><ol type="1">
<li>A request for one IPv4 and one IPv6 address, in two groups using the default command executor</li>
</ol>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;TaskInfo {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  ...</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  command: ...,</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  container: ContainerInfo {</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    network_infos: [</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;      NetworkInfo {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        ip_addresses: [</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;          IPAddress {</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;            protocol: IPv4;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;            ip_address: None;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;          },</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;          IPAddress {</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;            protocol: IPv6;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;            ip_address: None;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;          }</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        ]</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        groups: [&quot;dev&quot;, &quot;test&quot;];</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;        labels: None;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;      }</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    ]</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;  }</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;}</div></div><!-- fragment --><ol type="1">
<li>A request for two network interfaces, each with one IP address, each in a different network group using the default command executor</li>
</ol>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;TaskInfo {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  ...</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  command: ...,</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  container: ContainerInfo {</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    network_infos: [</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;      NetworkInfo {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        ip_addresses: [</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;          IPAddress {</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;            protocol: None;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;            ip_address: None;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;          }</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        ]</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;        groups: [&quot;foo&quot;];</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;        labels: None;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;      },</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;      NetworkInfo {</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        ip_addresses: [</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;          IPAddress {</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;            protocol: None;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;            ip_address: None;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;          }</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;        ]</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;        groups: [&quot;bar&quot;];</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;        labels: None;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;      },</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    ]</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;  }</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;}</div></div><!-- fragment --><ol type="1">
<li>A request for a specific IP address using a custom executor</li>
</ol>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;TaskInfo {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  ...</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  executor: ExecutorInfo {</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    ...,</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    container: ContainerInfo {</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;      network_infos: [</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        NetworkInfo {</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;          ip_addresses: [</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;            IPAddress {</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;              protocol: None;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;              ip_address: &quot;10.1.2.3&quot;;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;            }</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;          ]</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;          groups: [];</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;          labels: None;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        }</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;      ]</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    }</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;  }</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;}</div></div><!-- fragment --><p>NOTE: The Mesos Containerizer will reject any CommandInfo that has a ContainerInfo. For this reason, when opting in to network isolation when using the Mesos Containerizer, set TaskInfo.ContainerInfo.NetworkInfo.</p>
<h2>Address Discovery</h2>
<p>The NetworkInfo message allows frameworks to request IP address(es) to be assigned at task launch time on the Mesos agent. After opting in to network isolation for a given executor's container in this way, frameworks will need to know what address(es) were ultimately assigned in order to perform health checks, or any other out-of-band communication.</p>
<p>This is accomplished by adding a new field to the TaskStatus message.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;message ContainerStatus {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;   repeated NetworkInfo network_infos;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;}</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;message TaskStatus {</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  ...</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;  optional ContainerStatus container;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  ...</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;};</div></div><!-- fragment --><p>Further, the container IP addresses are also exposed via Master's state endpoint. The <a class="el" href="namespaceJSON.html">JSON</a> output from Master's state endpoint contains a list of task statuses. If a task's container was started with it's own IP address, the assigned IP address will be exposed as part of the <code>TASK_RUNNING</code> status.</p>
<p>NOTE: Since per-container address(es) are strictly opt-in from the framework, the framework may ignore the IP address(es) provided in StatusUpdate if it didn't set NetworkInfo in the first place.</p>
<h2>Writing a Custom <a class="el" href="classNetwork.html">Network</a> Isolator Module</h2>
<p>A network isolator module implements the Isolator interface provided by Mesos. The module is loaded as a dynamic shared library in to the Mesos Agent and gets hooked up in the container launch sequence. A network isolator may communicate with external IPAM and network virtualizer tools to fulfill framework requirements.</p>
<p>In terms of the Isolator API, there are three key callbacks that a network isolator module should implement:</p>
<ol type="1">
<li><code><a class="el" href="namespacecgroups.html#a4bf20862574beb5b0f9af7799489866f">Isolator::prepare()</a></code> provides the module with a chance to decide whether or not the enable network isolation for the given task container. If the network isolation is to be enabled, the Isolator::prepare call would inform the Agent to create a private network namespace for the coordinator. It is this interface, that will also generate an IP address (statically or with the help of an external IPAM agent) for the container.</li>
<li><code>Isolator::isolate()</code> provide the module with the opportunity to <em>isolate</em> the container <em>after</em> it has been created but before the executor is launched inside the container. This would involve creating virtual ethernet adapter for the container and assigning it an IP address. The module can also use help of an external network virtualizer/isolator for setting up network for the container.</li>
<li><code><a class="el" href="namespacecgroups.html#a12d210f286e5fcf7993c0c90b9459606">Isolator::cleanup()</a></code> is called when the container terminates. This allows the module to perform any cleanups such as recovering resources and releasing IP addresses as needed. </li>
</ol>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
