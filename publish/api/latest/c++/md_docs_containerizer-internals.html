<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Apache Mesos: containerizer-internals</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Apache Mesos
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">containerizer-internals </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
 <h2>layout: documentation </h2>
<h1>Containerizer</h1>
<p>Containerizers are Mesos components responsible for launching containers. They own the containers launched for the tasks/executors, and are responsible for their isolation, resource management, and events (e.g., statistics).</p>
<h1>Containerizer internals</h1>
<h3>Containerizer creation and launch</h3>
<ul>
<li>Agent creates a containerizer based on the flags (using slave flag <code>--containerizers</code>). If multiple containerizers (e.g., docker, mesos) are specified using the <code>--containerizers</code> flag, then the composing containerizer will be used to create a containerizer.</li>
<li>If an executor is not specified in <code>TaskInfo</code>, Mesos agent will use the default executor for the task (depending on the Containerizer the agent is using, it could be <code>mesos-executor</code> or <code>mesos-docker-executor</code>). TODO: Update this after MESOS-1718 is completed. After this change, master will be responsible for generating executor information.</li>
</ul>
<h3>Types of containerizers</h3>
<p>Mesos currently supports the following containerizers:</p>
<ul>
<li>Composing</li>
<li><a class="el" href="docker-containerizer_8md.html">Docker</a></li>
<li><a class="el" href="containerizer_8md.html">Mesos</a></li>
<li><a class="el" href="external-containerizer_8md.html">External</a> (deprecated)</li>
</ul>
<h4>Composing Containerizer</h4>
<p>Composing containerizer will compose the specified containerizers (using slave flag <code>--containerizers</code>) and act like a single containerizer. This is an implementation of <code>composite</code> design pattern.</p>
<h4><a class="el" href="classDocker.html">Docker</a> Containerizer</h4>
<p><a class="el" href="classDocker.html">Docker</a> containerizer manages containers using docker engine provided in the docker package.</p>
<h5>Container launch</h5>
<ul>
<li><a class="el" href="classDocker.html">Docker</a> containerizer will attempt to launch the task in docker only if <code>ContainerInfo::type</code> is set to DOCKER.</li>
<li><a class="el" href="classDocker.html">Docker</a> containerizer will first pull the image.</li>
<li>Calls pre-launch hook.</li>
<li>The executor will be launched in one of the two ways:</li>
</ul>
<p>A) Mesos agent runs in a docker container</p>
<ul>
<li>This is indicated by the presence of agent flag <code>--docker_mesos_image</code>. In this case, the value of flag <code>--docker_mesos_image</code> is assumed to be the docker image used to launch the Mesos agent.</li>
<li>If the task includes an executor (custom executor), then that executor is launched in a docker container.</li>
<li>If the task does not include an executor i.e. it defines a command, the default executor <code>mesos-docker-executor</code> is launched in a docker container to execute the command via <a class="el" href="classDocker.html">Docker</a> CLI.</li>
</ul>
<p>B) Mesos agent does not run in a docker container</p>
<ul>
<li>If the task includes an executor (custom executor), then that executor is launched in a docker container.</li>
<li>If task does not include an executor i.e. it defines a command, a subprocess is forked to execute the default executor <code>mesos-docker-executor</code>. <code>mesos-docker-executor</code> then spawns a shell to execute the command via <a class="el" href="classDocker.html">Docker</a> CLI.</li>
</ul>
<h4>Mesos Containerizer</h4>
<p>Mesos containerizer is the native Mesos containerizer. Mesos Containerizer will handle any executor/task that does not specify <code>ContainerInfo::DockerInfo</code>.</p>
<h5>Container launch</h5>
<ul>
<li>Calls prepare on each isolator.</li>
<li>Forks the executor using Launcher (see <a href="#Launcher">Launcher</a>). The forked child is blocked from executing until it is been isolated.</li>
<li>Isolate the executor. Call isolate with the pid for each isolator (see <a href="#Isolators">Isolators</a>).</li>
<li>Fetch the executor.</li>
<li>Exec the executor. The forked child is signalled to continue. It will first execute any preparation commands from isolators and then exec the executor.</li>
</ul>
<p><a class="anchor" id="Launcher"></a> </p><h5>Launcher</h5>
<p>Launcher is responsible for forking/destroying containers.</p>
<ul>
<li>Forks a new process in the containerized context. The child will exec the binary at the given path with the given argv, flags, and environment.</li>
<li>The I/O of the child will be redirected according to the specified I/O descriptors.</li>
</ul>
<h6>Linux launcher</h6>
<ul>
<li>Creates a “freezer” cgroup for the container.</li>
<li>Creates posix “pipe” to enable communication between host (parent process) and container process.</li>
<li>Spawn child process(container process) using <code>clone</code> system call.</li>
<li>Moves the new container process to the freezer hierarchy.</li>
<li>Signals the child process to continue (exec’ing) by writing a character to the write end of the pipe in the parent process.</li>
</ul>
<h6>Posix launcher (TBD)</h6>
<p><a class="anchor" id="Isolators"></a> </p><h5>Isolators</h5>
<p>Isolators are responsible for creating an environment for the containers where resources like cpu, network, storage and memory can be isolated from other containers.</p>
<h3>Containerizer states</h3>
<h4><a class="el" href="classDocker.html">Docker</a></h4>
<ul>
<li>FETCHING</li>
<li>PULLING</li>
<li>RUNNING</li>
<li>DESTROYING</li>
</ul>
<h4>Mesos</h4>
<ul>
<li>PREPARING</li>
<li>ISOLATING</li>
<li>FETCHING</li>
<li>RUNNING</li>
<li>DESTROYING </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
