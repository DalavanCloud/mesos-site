<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Apache Mesos: oversubscription</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Apache Mesos
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">oversubscription </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
 <h2>layout: documentation </h2>
<h1>Oversubscription</h1>
<p>High-priority user-facing services are typically provisioned on large clusters for peak load and unexpected load spikes. Hence, for most of time, the provisioned resources remain underutilized. Oversubscription takes advantage of temporarily unused resources to execute best-effort tasks such as background analytics, video/image processing, chip simulations, and other low priority jobs.</p>
<h2>How does it work?</h2>
<p>Oversubscription was introduced in Mesos 0.23.0 and adds two new slave components: a Resource Estimator and a Quality of Service (QoS) Controller, alongside extending the existing resource allocator, resource monitor, and mesos slave. The new components and their interactions are illustrated below.</p>
<div class="image">
<img src="images/oversubscription-overview.jpg"  alt="Oversubscription overview"/>
</div>
<h3>Resource estimation</h3>
<ul>
<li>(1) The first step is to identify the amount of oversubscribed resources. The resource estimator taps into the resource monitor and periodically gets usage statistics via <code>ResourceStatistic</code> messages. The resource estimator applies logic based on the collected resource statistics to determine the amount of oversubscribed resources. This can be a series of control algorithms based on measured resource usage slack (allocated but unused resources) and allocation slack.</li>
<li>(2) The slave keeps polling estimates from the resource estimator and tracks the latest estimate.</li>
<li>(3) The slave will send the total amount of oversubscribed resources to the master when the latest estimate is different from the previous estimate.</li>
</ul>
<h3>Resource tracking &amp; scheduling algorithm</h3>
<ul>
<li>(4) The allocator keeps track of the oversubscribed resources separately from regular resources and annotate those resources as <code>revocable</code>. It is up to the resource estimator to determine which types of resources can be oversubscribed. It is recommended only to oversubscribe <em>compressible</em> resources such as cpu shares, bandwidth, etc.</li>
</ul>
<h3>Frameworks</h3>
<ul>
<li>(5) Frameworks can choose to launch tasks on revocable resources by using the regular <code>launchTasks()</code> API. To safe-guard frameworks that are not designed to deal with preemption, only frameworks registering with the <code>REVOCABLE_RESOURCES</code> capability set in its framework info will receive offers with revocable resources. Further more, revocable resources cannot be dynamically reserved and persistent volumes should not be created on revocable disk resources.</li>
</ul>
<h3>Task launch</h3>
<ul>
<li>The revocable task is launched as usual when the <code>runTask</code> request is received on the slave. The resources will still be marked as revocable and isolators can take appropriate actions, if certain resources need to be setup differently for revocable and regular tasks.</li>
</ul>
<blockquote class="doxtable">
<p>NOTE: If any resource used by a task or executor is </p>
</blockquote>
<p>revocable, the whole container is treated as a revocable container and can therefore be killed or throttled by the QoS Controller.</p>
<h3>Interference detection</h3>
<ul>
<li>(6) When the revocable task is running, it is important to constantly monitor the original task running on those resources and guarantee performance based on an SLA. In order to react to detected interference, the QoS controller needs to be able to kill or throttle running revocable tasks.</li>
</ul>
<h2>Enabling frameworks to use oversubscribed resources</h2>
<p>Frameworks planning to use oversubscribed resources need to register with the <code>REVOCABLE_RESOURCES</code> capability set:</p>
<div class="fragment"><div class="line">FrameworkInfo framework;</div><div class="line">framework.set_name(<span class="stringliteral">&quot;Revocable framework&quot;</span>);</div><div class="line"></div><div class="line">framework.add_capabilities()-&gt;set_type(</div><div class="line">    FrameworkInfo::Capability::REVOCABLE_RESOURCES);</div></div><!-- fragment --><p>From that point on, the framework will start to receive revocable resources in offers.</p>
<blockquote class="doxtable">
<p>NOTE: That there is no guarantee that the Mesos cluster has oversubscription </p>
</blockquote>
<p>enabled. If not, no revocable resources will be offered. See below for instructions how to configure Mesos for oversubscription.</p>
<h3>Launching tasks using revocable resources</h3>
<p>Launching tasks using revocable resources is done through the existing <code>launchTasks</code> API. Revocable resources will have the <code>revocable</code> field set. See below for an example offer with regular and revocable resources.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  &quot;id&quot;: &quot;20150618-112946-201330860-5050-2210-0000&quot;,</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  &quot;framework_id&quot;: &quot;20141119-101031-201330860-5050-3757-0000&quot;,</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  &quot;slave_id&quot;: &quot;20150618-112946-201330860-5050-2210-S1&quot;,</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  &quot;hostname&quot;: &quot;foobar&quot;,</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  &quot;resources&quot;: [</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    {</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;      &quot;name&quot;: &quot;cpus&quot;,</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;      &quot;type&quot;: &quot;SCALAR&quot;,</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;      &quot;scalar&quot;: {</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        &quot;value&quot;: 2.0</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;      },</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;      &quot;role&quot;: &quot;*&quot;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    }, {</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;      &quot;name&quot;: &quot;mem&quot;,</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;      &quot;type&quot;: &quot;SCALAR&quot;,</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;      &quot;scalar&quot;: {</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;        &quot;value&quot;: 512.0</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;      },</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;      &quot;role&quot;: &quot;*&quot;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    },</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    {</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;      &quot;name&quot;: &quot;cpus&quot;,</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;      &quot;type&quot;: &quot;SCALAR&quot;,</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;      &quot;scalar&quot;: {</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;        &quot;value&quot;: 0.45</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;      },</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;      &quot;role&quot;: &quot;*&quot;,</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;      &quot;revocable&quot;: {}</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    }</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;  ]</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;}</div></div><!-- fragment --><h2>Writing a custom resource estimator</h2>
<p>The resource estimator estimates and predicts the total resources used on the slave and informs the master about resources that can be oversubscribed. By default, Mesos comes with a <code>noop</code> and a <code>fixed</code> resource estimator. The <code>noop</code> estimator only provides an empty estimate to the slave and stalls, effectively disabling oversubscription. The <code>fixed</code> estimator doesn't use the actual measured slack, but oversubscribes the node with fixed resource amount (defined via a command line flag).</p>
<p>The interface is defined below:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>ResourceEstimator</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="comment">// Initializes this resource estimator. This method needs to be</span></div><div class="line">  <span class="comment">// called before any other member method is called. It registers</span></div><div class="line">  <span class="comment">// a callback in the resource estimator. The callback allows the</span></div><div class="line">  <span class="comment">// resource estimator to fetch the current resource usage for each</span></div><div class="line">  <span class="comment">// executor on slave.</span></div><div class="line">  <span class="keyword">virtual</span> <a class="code" href="classTry.html">Try&lt;Nothing&gt;</a> <a class="code" href="namespacesystemd.html#a4e45b8163baf6d307c9884d624472402">initialize</a>(</div><div class="line">      <span class="keyword">const</span> lambda::function&lt;<a class="code" href="classprocess_1_1Future.html">process::Future&lt;ResourceUsage&gt;</a>()&gt;&amp; <a class="code" href="namespacemesos_1_1internal.html#a91a5bc5e418e8712bb512721b5abc46d">usage</a>) = 0;</div><div class="line"></div><div class="line">  <span class="comment">// Returns the current estimation about the *maximum* amount of</span></div><div class="line">  <span class="comment">// resources that can be oversubscribed on the slave. A new</span></div><div class="line">  <span class="comment">// estimation will invalidate all the previously returned</span></div><div class="line">  <span class="comment">// estimations. The slave will be calling this method periodically</span></div><div class="line">  <span class="comment">// to forward it to the master. As a result, the estimator should</span></div><div class="line">  <span class="comment">// respond with an estimate every time this method is called.</span></div><div class="line">  <span class="keyword">virtual</span> <a class="code" href="classprocess_1_1Future.html">process::Future&lt;Resources&gt;</a> oversubscribable() = 0;</div><div class="line">};</div></div><!-- fragment --><h2>Writing a custom QoS controller</h2>
<p>The interface for implementing custom QoS Controllers is defined below:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>QoSController</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="comment">// Initializes this QoS Controller. This method needs to be</span></div><div class="line">  <span class="comment">// called before any other member method is called. It registers</span></div><div class="line">  <span class="comment">// a callback in the QoS Controller. The callback allows the</span></div><div class="line">  <span class="comment">// QoS Controller to fetch the current resource usage for each</span></div><div class="line">  <span class="comment">// executor on slave.</span></div><div class="line">  <span class="keyword">virtual</span> <a class="code" href="classTry.html">Try&lt;Nothing&gt;</a> <a class="code" href="namespacesystemd.html#a4e45b8163baf6d307c9884d624472402">initialize</a>(</div><div class="line">      <span class="keyword">const</span> lambda::function&lt;<a class="code" href="classprocess_1_1Future.html">process::Future&lt;ResourceUsage&gt;</a>()&gt;&amp; <a class="code" href="namespacemesos_1_1internal.html#a91a5bc5e418e8712bb512721b5abc46d">usage</a>) = 0;</div><div class="line"></div><div class="line">  <span class="comment">// A QoS Controller informs the slave about corrections to carry</span></div><div class="line">  <span class="comment">// out, but returning futures to QoSCorrection objects. For more</span></div><div class="line">  <span class="comment">// information, please refer to mesos.proto.</span></div><div class="line">  <span class="keyword">virtual</span> <a class="code" href="classprocess_1_1Future.html">process::Future&lt;std::list&lt;QoSCorrection&gt;</a>&gt; corrections() = 0;</div><div class="line">};</div></div><!-- fragment --><blockquote class="doxtable">
<p>NOTE The QoS Controller must not block <code>corrections()</code>. Back the QoS Controller with it's own libprocess actor instead. </p>
</blockquote>
<p>The QoS Controller informs the slave that particular corrective actions need to be made. Each corrective action contains information about executor or task and the type of action to perform.</p>
<p>Mesos comes with a <code>noop</code> and a <code>load</code> qos controller. The <code>noop</code> controller does not provide any corrections, thus does not assure any quality of service for regular tasks. The <code>load</code> controller is ensuring the total system load doesn't exceed a configurable thresholds and as a result try to avoid the cpu congestion on the node. If the load is above the thresholds controller evicts all the revocable executors. These thresholds are configurable via two module parameters <code>load_threshold_5min</code> and <code>load_threshold_15min</code>. They represent standard unix load averages in the system. 1 minute system load is ignored, since for oversubscription use case it can be a misleading signal.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;message QoSCorrection {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  enum Type {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    KILL = 1; // Terminate an executor.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  }</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  message Kill {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    optional FrameworkID framework_id = 1;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    optional ExecutorID executor_id = 2;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;  }</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;  required Type type = 1;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;  optional Kill kill = 2;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;}</div></div><!-- fragment --><h2>Configuring oversubscription</h2>
<p>Five new flags has been added to the slave:</p>
<table  class="table table-striped">
</table>
<p>Flag  </p>
<p>Explanation  &lt;/thead&gt;</p>
<p>&ndash;oversubscribed_resources_interval=VALUE  </p>
<p>The slave periodically updates the master with the current estimation about the total amount of oversubscribed resources that are allocated and available. The interval between updates is controlled by this flag. (default: 15secs)  </p>
<p>&ndash;qos_controller=VALUE  </p>
<p>The name of the QoS Controller to use for oversubscription.  </p>
<p>&ndash;qos_correction_interval_min=VALUE  </p>
<p>The slave polls and carries out QoS corrections from the QoS Controller based on its observed performance of running tasks. The smallest interval between these corrections is controlled by this flag. (default: 0ns)  </p>
<p>&ndash;resource_estimator=VALUE  </p>
<p>The name of the resource estimator to use for oversubscription.  </p>
<p>The <code>fixed</code> resource estimator is enabled as follows:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;--resource_estimator=&quot;org_apache_mesos_FixedResourceEstimator&quot;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;--modules=&#39;{</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  &quot;libraries&quot;: {</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    &quot;file&quot;: &quot;/usr/local/lib64/libfixed_resource_estimator.so&quot;,</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    &quot;modules&quot;: {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;      &quot;name&quot;: &quot;org_apache_mesos_FixedResourceEstimator&quot;,</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;      &quot;parameters&quot;: {</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        &quot;key&quot;: &quot;resources&quot;,</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        &quot;value&quot;: &quot;cpus:14&quot;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;      }</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    }</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;  }</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;}&#39;</div></div><!-- fragment --><p>In the example above, a fixed amount of 14 cpus will be offered as revocable resources.</p>
<p>The <code>load</code> qos controller is enabled as follows:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;--qos_controller=&quot;org_apache_mesos_LoadQoSController&quot;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;--qos_correction_interval_min=&quot;20secs&quot;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;--modules=&#39;{</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  &quot;libraries&quot;: {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    &quot;file&quot;: &quot;/usr/local/lib64/libload_qos_controller.so&quot;,</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    &quot;modules&quot;: {</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;      &quot;name&quot;: &quot;org_apache_mesos_LoadQoSController&quot;,</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;      &quot;parameters&quot;: [</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        {</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;          &quot;key&quot;: &quot;load_threshold_5min&quot;,</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;          &quot;value&quot;: &quot;6&quot;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;        },</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;        {</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;          &quot;key&quot;: &quot;load_threshold_15min&quot;,</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;          &quot;value&quot;: &quot;4&quot;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;        }</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;      ]</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    }</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;  }</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;}&#39;</div></div><!-- fragment --><p>In the example above, when standard unix system load average for 5 minutes will be above 6, or for 15 minutes will be above 4 then slave will evict all the <code>revocable</code> executors. <code>LoadQoSController</code> will be effectively run every 20 seconds.</p>
<p>To install a custom resource estimator and QoS controller, please refer to the <a class="el" href="modules_8md.html">modules documentation</a>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
