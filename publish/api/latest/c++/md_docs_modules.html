<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Apache Mesos: modules</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Apache Mesos
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">modules </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
 <h2>layout: documentation </h2>
<h1>Mesos Modules</h1>
<p>Experimental support for Mesos modules was introduced in Mesos 0.21.0.</p>
<h3>Disclaimer</h3>
<ul>
<li>Use and development of Mesos modules is at own risk!</li>
<li>Please direct all questions to the relevant module writer and/or write to <a href="#" onclick="location.href='mai'+'lto:'+'mod'+'ul'+'es@'+'me'+'sos'+'.a'+'pac'+'he'+'.or'+'g'; return false;">modul<span style="display: none;">.nosp@m.</span>es@m<span style="display: none;">.nosp@m.</span>esos.<span style="display: none;">.nosp@m.</span>apac<span style="display: none;">.nosp@m.</span>he.or<span style="display: none;">.nosp@m.</span>g</a>. Questions related to modules sent to user and dev list will be redirected to the modules list.</li>
</ul>
<h2>What are Mesos modules?</h2>
<p>Mesos modules provide a way to easily extend inner workings of Mesos by creating and using shared libraries that are loaded on demand. Modules can be used to customize Mesos without having to recompiling/relinking for each specific use case. Modules can isolate external dependencies into separate libraries, thus resulting into a smaller Mesos core. Modules also make it easy to experiment with new features. For example, imagine loadable allocators that contain a VM (Lua, Python, ...) which makes it possible to try out new allocator algorithms written in scripting languages without forcing those dependencies into the project. Finally, modules provide an easy way for third parties to easily extend Mesos without having to know all the internal details.</p>
<h2><a class="anchor" id="Invoking"></a>Invoking Mesos modules</h2>
<p>The command-line flag <code>--modules</code> is available for Mesos master, slave, and tests to specify a list of modules to be loaded and be available to the internal subsystems.</p>
<p>Use <code>--modules=filepath</code> to specify the list of modules via a file containing a JSON-formatted string. 'filepath' can be of the form '<a href="file:///path/to/file'">file:///path/to/file'</a> or '/path/to/file'.</p>
<p>Use <code>--modules="{...}"</code> to specify the list of modules inline.</p>
<h3>Example <a class="el" href="namespaceJSON.html">JSON</a> strings:</h3>
<ol type="1">
<li>Load a library <code>libfoo.so</code> with two modules <code>org_apache_mesos_bar</code> and <code>org_apache_mesos_baz</code>. <pre class="fragment"> {
   "libraries": [
     {
       "file": "/path/to/libfoo.so",
       "modules": [
         {
           "name": "org_apache_mesos_bar",
         },
         {
           "name": "org_apache_mesos_baz"
         }
       ]
     }
   ]
 }
</pre></li>
<li>Load the module <code>org_apache_mesos_bar</code> from the library <code>foo</code> and pass the command-line argument <code>X</code> with value <code>Y</code> (module <code>org_apache_mesos_baz</code> is loaded without any command-line parameters): <pre class="fragment"> {
   "libraries": [
     {
       "name": "foo",
       "modules": [
         {
           "name": "org_apache_mesos_bar"
           "parameters": [
             {
               "key": "X",
               "value": "Y",
             }
           ]
         },
         {
           "name": "org_apache_mesos_baz"
         }
       ]
     }
   ]
 }
</pre></li>
<li>Specifying modules inline: <pre class="fragment"> --modules='{"libraries":[{"file":"/path/to/libfoo.so", "modules":[{"name":"org_apache_mesos_bar"}]}]}'
</pre></li>
</ol>
<h3>Library names</h3>
<p>For each library, at least one of the "file" or "name" parameter must be specified. The "file" parameter may refer to a filename (e.g., "libfoo.so"), a relative path (e.g., "myLibs/libfoo.so"), or an absolute path (e.g., "/home/mesos/lib/libfoo.so"). The "name" parameter refers to a library name (e.g., "foo"). If "name" is specified, it is automatically expanded to a proper library name for the current platform (e.g., "foo" gets expanded to "libfoo.so" on Linux, and "libfoo.dylib" on OS X).</p>
<p>If a library path is not specified in the "file" parameter, the library is searched in the standard library paths or directories pointed to by the <code>LD_LIBRARY_PATH</code> (<code>DYLD_LIBRARY_PATH</code> on OS X) environment variable.</p>
<p>If both "file" and "name" are specified, "name" is ignored.</p>
<h2>What kinds of modules are supported?</h2>
<p>Here are the various module kinds currently available.</p>
<h3>Allocator</h3>
<p>The Mesos master's <em>allocator</em> periodically determines which framework(s) should be offered the cluster's available resources. Allocator modules enable experimenting with specialized resource allocation algorithms. An example of these could be an allocator that provides a feature currently not supported by the built-in Hierarchical Dominant Resource Fairness allocator, like oversubscription with preemption.</p>
<p>To load a custom allocator into Mesos master, you need to:</p>
<ul>
<li>Introduce it to the Mesos master by listing it in the <code>--modules</code> configuration,</li>
<li>Select it as the allocator via the <code>--allocator</code> flag.</li>
</ul>
<p>For example, the following command will run the Mesos master with <code>ExternalAllocatorModule</code> (see <a href="#Example-JSON-strings">this section</a> for <a class="el" href="namespaceJSON.html">JSON</a> format): </p><pre class="fragment">./bin/mesos-master.sh --work_dir=m/work --modules="file://&lt;modules-including-allocator&gt;.json" --allocator=ExternalAllocatorModule
</pre><h3>Anonymous</h3>
<p>Anonymous modules do <b>not</b> receive any callbacks but simply coexists with their parent process.</p>
<p>Unlike other named modules, an anonymous module does not directly replace or provide essential Mesos functionality (such as an Isolator module does). Unlike a decorator module it does not directly add or inject data into Mesos core either.</p>
<p>Anonymous modules do not require any specific selectors (flags) as they are immediately instantiated when getting loaded via the <code>--modules</code> flag by the Mesos master or slave.</p>
<h3>Authentication</h3>
<p>Authenticatee and Authenticator modules allow for third parties to quickly develop and plug-in new authentication methods. An example for such modules could be to support PAM (LDAP, MySQL, NIS, UNIX) backed authentication.</p>
<h3>Hook</h3>
<p>Similar to Apache Webserver Modules, hooks allows module writers to tie into internal components which may not be suitable to be abstracted entirely behind modules but rather lets them define actions on so-called hooks.</p>
<p>The available hooks API is defined in <a class="el" href="hook_8hpp.html">mesos/hook.hpp</a> and for each hook defines the insertion point and available context. An example of this context is the task information which is passed to masterLaunchTaskHook.</p>
<p>Some hooks take in an object (e.g. TaskInfo) and return all or part of that object (e.g. task labels), so that the hook can modify or replace the contents in-flight. These hooks are referred to as <em>decorators</em>.</p>
<p>In order to enable decorator modules to remove metadata (environment variables or labels), the effect of the return value for decorator hooks changed in Mesos 0.23.0.</p>
<p>The Result&lt;T&gt; return values before and after Mesos 0.23.0 means:</p>
<table class="doxtable">
<tr>
<th>State </th><th>Before (0.22.x) </th><th>After (0.23.0+)  </th></tr>
<tr>
<td><a class="el" href="classError.html">Error</a> </td><td><a class="el" href="classError.html">Error</a> is propagated to the call-site </td><td>No change  </td></tr>
<tr>
<td><a class="el" href="structNone.html">None</a> </td><td>The result of the decorator is not applied </td><td>No change  </td></tr>
<tr>
<td>Some </td><td>The result of the decorator is appended </td><td>The result of the decorator overwrites the final labels/environment object  </td></tr>
</table>
<p>To load a hook into Mesos, you need to</p>
<ul>
<li>introduce it to Mesos by listing it in the <code>--modules</code> configuration,</li>
<li>select it as a hook module via the <code>--hooks</code> flag.</li>
</ul>
<p>For example, the following command will run the Mesos slave with the <code>TestTaskHook</code> hook: </p><pre class="fragment">./bin/mesos-slave.sh --master=&lt;IP&gt;:&lt;PORT&gt; --modules="file://&lt;path-to-modules-config&gt;.json" --hooks=TestTaskHook
</pre><h3>Isolator</h3>
<p>Isolator modules enable experimenting with specialized isolation and monitoring capabilities. Examples of these could be 3rdparty resource isolation mechanisms for GPGPU hardware, networking, etc.</p>
<h2>Writing Mesos modules</h2>
<h3>A HelloWorld module</h3>
<p>The following snippet describes the implementation of a module named "org_apache_mesos_bar" of "TestModule" kind:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="test__module_8hpp.html">test_module.hpp</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>TestModuleImpl : <span class="keyword">public</span> <a class="code" href="classTestModule.html">TestModule</a></div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  TestModuleImpl()</div><div class="line">  {</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;HelloWorld!&quot;</span> &lt;&lt; std::endl;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">int</span> <a class="code" href="classTestModule.html#a5dfede21c582de30be92adf244179736">foo</a>(<span class="keywordtype">char</span> a, <span class="keywordtype">long</span> b)</div><div class="line">  {</div><div class="line">    <span class="keywordflow">return</span> a + b;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">int</span> <a class="code" href="classTestModule.html#a0e8db9d31c82035065bf347c66cb5772">bar</a>(<span class="keywordtype">float</span> a, <span class="keywordtype">double</span> b)</div><div class="line">  {</div><div class="line">    <span class="keywordflow">return</span> a * b;</div><div class="line">  }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="classTestModule.html">TestModule</a>* <a class="code" href="namespacecgroups.html#a2ecc89636706df947027a4c3c2100fbe">create</a>()</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classTestModule.html#a945295de6c98244a5dcb47278a58dd15">TestModule</a>();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> compatible()</div><div class="line">{</div><div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Declares a module named &#39;org_apache_mesos_TestModule&#39; of</span></div><div class="line"><span class="comment">// &#39;TestModule&#39; kind.</span></div><div class="line"><span class="comment">// Mesos core binds the module instance pointer as needed.</span></div><div class="line"><span class="comment">// The compatible() hook is provided by the module for compatibility checks.</span></div><div class="line"><span class="comment">// The create() hook returns an object of type &#39;TestModule&#39;.</span></div><div class="line"><a class="code" href="structmesos_1_1modules_1_1Module_3_01TestModule_01_4.html">mesos::modules::Module&lt;TestModule&gt;</a> org_apache_mesos_TestModule(</div><div class="line">    <a class="code" href="include_2mesos_2module_8hpp.html#adf787bc78b1f3ba0b0ecf71a0487ee2a">MESOS_MODULE_API_VERSION</a>,</div><div class="line">    MESOS_VERSION,</div><div class="line">    <span class="stringliteral">&quot;Apache Mesos&quot;</span>,</div><div class="line">    <span class="stringliteral">&quot;modules@mesos.apache.org&quot;</span>,</div><div class="line">    <span class="stringliteral">&quot;This is a test module.&quot;</span>,</div><div class="line">    compatible,</div><div class="line">    <a class="code" href="namespacecgroups.html#a2ecc89636706df947027a4c3c2100fbe">create</a>);</div></div><!-- fragment --><h3>Building a module</h3>
<p>The following assumes that Mesos is installed in the standard location, i.e. the Mesos dynamic library and header files are available.</p>
<p>g++ -lmesos -fpic -o test_module.o test_module.cpp $ gcc -shared -o libtest_module.so test_module.o</p>
<h3>Testing a modules</h3>
<p>Apart from testing the module by hand with explicit use of &ndash;modules flag, one can run the entire mesos test suite with the given module. For example, the following command will run the mesos test suite with the <code>org_apache_mesos_TestCpuIsolator</code> module selected for isolation: </p><pre class="fragment">./bin/mesos-tests.sh --modules="/home/kapil/mesos/isolator-module/modules.json" --isolation="org_apache_mesos_TestCpuIsolator"
</pre><h3>Module naming convention</h3>
<p>Each module name should be unique. Having duplicate module names in the Json string will cause the process to abort.</p>
<p>Therefore, we encourage module writers to name their modules according to Java package naming scheme (<a href="http://docs.oracle.com/javase/tutorial/java/package/namingpkgs.html">http://docs.oracle.com/javase/tutorial/java/package/namingpkgs.html</a>).</p>
<p>For example:</p>
<table class="doxtable">
<tr>
<th>Module Name  </th><th>Module Domain name  </th><th><p class="starttd">Module Symbol Name  </p>
<p class="endtd"></p>
</th></tr>
<tr>
<td>foobar  </td><td>mesos.apache.org  </td><td><p class="starttd">org_apache_mesos_foobar  </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>barBaz  </td><td>example.com  </td><td>com_example_barBaz  </td></tr>
</table>
<p>In short:</p><ul>
<li>Keep case of module name.</li>
<li>Lower case and reverse domain.</li>
<li>Separate with underscore.</li>
<li>Do not simply use the kind name as module name.</li>
<li>Different modules from the same organization still need different names.</li>
</ul>
<h2>Module Versioning and backwards compatibility</h2>
<p>Before loading the above module, a dynamic library that contains the module needs to be loaded into Mesos. This happens early in Mesos startup code. The Mesos developer does not need to touch that code when introducing new module kinds. However, the developer is responsible for registering what versions of any given module are expected to remain compatible with Mesos as it progresses. This information is maintained in a table in <code>src/module/manager.cpp</code>. It contains an entry for every possible module kind that Mesos recognizes, each with a corresponding Mesos release version number. This number needs to be adjusted by the Mesos developer to reflect the current Mesos version whenever compatibility between Mesos and modules that get compiled against it gets broken. Given that module implementation for older Mesos versions can still be written in the future, this may be impossible to tell and so in doubt it is best to just bump the required module version to the current Mesos version. But if one can be reasonably sure, assuming cooperative module developers, that a certain kind of module will continue to function across several Mesos versions, the table provides an easy way to specify this.</p>
<p>For successfully loading the module, the following relationship must exist between the various versions:</p>
<p><code>kind version &lt;= Library version &lt;= Mesos version</code></p>
<table class="doxtable">
<tr>
<td>Mesos  </td><td>kind version  </td><td>Library  </td><td>Is module loadable  </td><td><p class="starttd">Reason  </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>0.18.0  </td><td>0.18.0  </td><td>0.18.0  </td><td>yes  </td><td><p class="starttd"></p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>0.29.0  </td><td>0.18.0  </td><td>0.18.0  </td><td>yes  </td><td><p class="starttd"></p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>0.29.0  </td><td>0.18.0  </td><td>0.21.0  </td><td>yes  </td><td><p class="starttd"></p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>0.18.0  </td><td>0.18.0  </td><td>0.29.0  </td><td>NO  </td><td><p class="starttd">Library compiled against a newer Mesos release.  </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>0.29.0  </td><td>0.21.0  </td><td>0.18.0  </td><td>NO  </td><td><p class="starttd">Module/Library older than the kind version supported by Mesos.  </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td>0.29.0  </td><td>0.29.0  </td><td>0.18.0  </td><td>NO  </td><td>Module/Library older than the kind version supported by Mesos.   </td></tr>
</table>
<h2>Mesos module API changes</h2>
<p>Record of incompatible changes to the modules API.</p>
<h3><a class="el" href="structVersion.html">Version</a> 2</h3>
<ul>
<li>Added support for module-specific command-line parameters.</li>
<li>Changed function signature for <a class="el" href="namespacecgroups.html#a2ecc89636706df947027a4c3c2100fbe">create()</a>.</li>
</ul>
<h3><a class="el" href="structVersion.html">Version</a> 1</h3>
<p>Initial version of the modules API.</p>
<h2>Appendix:</h2>
<h3><a class="el" href="namespaceJSON.html">JSON</a> Schema:</h3>
<pre class="fragment">{
  "type":"object",
  "required":false,
  "properties":{
    "libraries":{
      "type":"array",
      "required":false,
      "items":{
        "type":"object",
        "required":false,
        "properties":{
          "file":{
            "type":"string",
            "required":false
          },
          "name":{
            "type":"string",
            "required":false
          },
          "modules":{
            "type":"array",
            "required":false,
            "items":{
              "type":"object",
              "required":false,
              "properties":{
                "name":{
                  "type":"string",
                  "required":true
                },
                "parameters":{
                  "type":"array",
                  "required":false,
                  "items":{
                    "type":"object",
                    "required":false,
                    "properties":{
                      "key":{
                        "type":"string",
                        "required":true
                      },
                      "value":{
                        "type":"string",
                        "required":true
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}</pre> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
