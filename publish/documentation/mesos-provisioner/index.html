<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title></title>
		    <meta name="viewport" content="width=device-width, initial-scale=1.0">

		    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
		    <link rel="alternate" type="application/atom+xml" title="Apache Mesos Blog" href="/blog/feed.xml">
		    
		    <link href="../../assets/css/main.css" media="screen" rel="stylesheet" type="text/css" />
				
		    
			
			<!-- Google Analytics Magic -->
			<script type="text/javascript">
			  var _gaq = _gaq || [];
			  _gaq.push(['_setAccount', 'UA-20226872-1']);
			  _gaq.push(['_setDomainName', 'apache.org']);
			  _gaq.push(['_trackPageview']);

			  (function() {
			    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			  })();
			</script>
    </head>
    <body>
			<!-- magical breadcrumbs -->
			<div class="topnav">
			<ul class="breadcrumb">
			  <li>
					<div class="dropdown">
					  <a data-toggle="dropdown" href="#">Apache Software Foundation <span class="caret"></span></a>
					  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
							<li><a href="http://www.apache.org">Apache Homepage</a></li>
							<li><a href="http://www.apache.org/licenses/">License</a></li>
					  	<li><a href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>  
					  	<li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
							<li><a href="http://www.apache.org/security/">Security</a></li>
					  </ul>
					</div>
				</li>
				<li><a href="http://mesos.apache.org">Apache Mesos</a></li>
				
				
					<li><a href="/documentation
/">Documentation
</a></li>
				
				
			</ul><!-- /breadcrumb -->
			</div>
			
			<!-- navbar excitement -->
	    <div class="navbar navbar-static-top" role="navigation">
	      <div class="navbar-inner">
	        <div class="container">
						<a href="/" class="logo"><img src="/assets/img/mesos_logo.png" alt="Apache Mesos logo" /></a>
					<div class="nav-collapse">
						<ul class="nav nav-pills navbar-right">
						  <li><a href="/gettingstarted/">Getting Started</a></li>
						  <li><a href="/documentation/latest/">Documentation</a></li>
						  <li><a href="/downloads/">Downloads</a></li>
						  <li><a href="/community/">Community</a></li>
						</ul>
					</div>
	        </div>
	      </div>
	    </div><!-- /.navbar -->

      <div class="container">

			<div class="row-fluid">
	<div class="col-md-4">
		<h4>If you're new to Mesos</h4>
		<p>See the <a href="/gettingstarted/">getting started</a> page for more information about downloading, building, and deploying Mesos.</p>
		
		<h4>If you'd like to get involved or you're looking for support</h4>
		<p>See our <a href="/community/">community</a> page for more details.</p>
	</div>
	<div class="col-md-8">
		<h1>Mesos Image Provisioner</h1>

<h2>Motivation</h2>

<p>There are multiple container specifications, notably Docker, Appc (rkt), and recently OCP (oci). Most of the container specifications, to varying degrees, conflate image format specification with other components of a container, including execution and resource isolation, both in specification and implementation.</p>

<p>The goal of Mesos Image Provisioner is to extend the MesosContainerizer to support provisioning container filesystems from different image formats while composing with the existing Isolators for resource isolation.</p>

<p>Mesos image provisioner allows Mesos containers to be created and managed through Mesos containerizer to have a root filesystem provisioned with image bundles with common image specification formats such as AppContainer and Docker.</p>

<h2>Glossary</h2>

<p>Layer: A layer is typically a filesystem changeset.</p>

<p>Image: An image in this documentation refers to a container filesystem image. A filesystem image typically contains one or more layers.</p>

<h2>Framework API</h2>

<p>We introduced a new protobuf message <code>Image</code> that describes a container filesystem image.</p>

<pre><code class="{.proto}">message Image {
  enum Type {
    APPC = 1;
    DOCKER = 2;
    // More Image types.
  }

  message Appc {
    // Appc configurations.
  }

  message Docker {
    // Docker configurations
  }

  required Type type = 1;

  // Only one of the following image messages should be set to match
  // the type.
  optional Appc appc = 2;
  optional Docker docker = 3;
}
</code></pre>

<p>This <code>Image</code> message type contains the type of image specification and the corresponding configurations for that type.</p>

<p>The image type is currently supported to be specified in both ContainerInfo and Volume.</p>

<p>When ContainerInfo image is configured, the Mesos image provisioner provides a root filesystem to the task. On the other hand, when volume(s) are configured with an image,
that volume will be mounted with the image filesystem configured.</p>

<p>Image can both be configured in a Volume and in ContainerInfo at the same time.</p>

<h2>Setup and Agent Flags</h2>

<p>To run the agent to enable Mesos containerizer, you must launch the agent with mesos as a containerizer option, which is the default containerizer for the mesos agent. It also has to enable filesystem/linux as part of the enabled isolators. The supported image providers can also be configured through agent flags, as well as the supported image provider backend.</p>

<p>Mesos agent also needs to be running under linux with root permissions.</p>

<ul>
<li>Example: <code>mesos-slave --containerizers=mesos --image_providers=appc,docker --image_provisioner_backend=copy --isolation=filesystem/linux</code></li>
</ul>


<p>Each Image provider can have additional configurations that can be set.</p>

<h2>Mesos Image Provisioner</h2>

<p>Mesos provisioner forwards the container image request to the corresponding Image Provider to provision the image changesets (layers), and then ask the configured Backend to provision a root filesystem from the layers.</p>

<h2>Image providers</h2>

<p>An image provider is a provider that understands how to discover, download and unpack a particular image format.
Mesos agent supports multiple image providers and the <code>image_providers</code> agent flag allows operators to choose which ones to support.</p>

<h3>Appc</h3>

<p>https://github.com/appc/spec/blob/master/spec/aci.md</p>

<p>TODO(tnachen): Add Appc information.</p>

<h3>Docker</h3>

<p>https://github.com/docker/docker/blob/master/image/spec/v1.md</p>

<p>Docker image provider supports two different methods of finding and pulling images: local and registry. The <code>docker_registry</code> agent flag allows the slave to choose between these methods based on the URL scheme.</p>

<p>By specifying a URL in <code>docker_registry</code> agent flag pointing to a local directory (file:///tmp/mesos/images/docker), the provisioner will use the Local puller to find docker images based on image name and tag in the host filesystem.</p>

<p>If the URL configured in <code>docker_registry</code> isn&rsquo;t pointing to a local directory, it will be assumed to be a registry referring to a Docker registry. The Registry puller will find and download images by contacting Docker registry with the configured URL when no custom registry is specified.</p>

<p>Note that to run the Registry puller Mesos agent must be running with SSL enabled.</p>

<h2>Image provisioner backend</h2>

<p>A provisioner backend takes the layers that the image provider provided and build a root filesystem for a container or volume.</p>

<h3>Copy</h3>

<p>The Copy backend simply copies all the layers into a target root directory to create a root filesystem.</p>

<h3>Bind</h3>

<p>This is a specialized backend that may be useful for deployments using large (multi-GB) single-layer images <em>and</em> where more recent kernel features such as overlayfs are not available (overlayfs-based
backend tracked by MESOS-2971). For small images (10&rsquo;s to 100&rsquo;s of MB) the copy backend may be sufficient. Bind backend is faster than Copy as it requires nearly zero IO.</p>

<p>The Bind backend currently has these two limitations:
1) BindBackend supports only a single layer. Multi-layer images will fail to provision and the container will fail to launch!
2) The filesystem is read-only because all containers using this image share the source. Select writable areas can be achieved by mounting read-write volumes to places like /tmp, /var/tmp, /home, etc. using the ContainerInfo. These can be relative to the executor work directory. Since the filesystem is read-only, &lsquo;&ndash;sandbox_directory&rsquo; must already exist within the filesystem because the filesystem isolator is unable to create it!</p>

<h2>Internals</h2>

<p>The design doc is available <a href="https://docs.google.com/document/d/1Fx5TS0LytV7u5MZExQS0-g-gScX2yKCKQg9UPFzhp6U">here</a>.</p>

<h2>Related Docs</h2>

<p>For more information on the Mesos containerizer filesystem, namespace, and isolator features, visit <a href="/documentation/latest/./mesos-containerizer/">Mesos Containerizer</a>.
For more information on launching Docker containers through the Docker containerizer, visit <a href="/documentation/latest/./docker-containerizer/">Docker Containerizer</a>.</p>

	</div>
</div>

			
	      <hr>

				<!-- footer -->
	      <div class="footer">
	        <p>&copy; 2012-2015 <a href="http://apache.org">The Apache Software Foundation</a>.
	        Apache Mesos, the Apache feather logo, and the Apache Mesos project logo are trademarks of The Apache Software Foundation.<p>
	      </div><!-- /footer -->

	    </div> <!-- /container -->

	    <!-- JS -->
	    <script src="//code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script>
			<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js" type="text/javascript"></script>
    </body>
</html>
